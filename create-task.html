<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание новой задачи</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body class="create-task-page"> 
    <div class="container">
        <h1>Создание новой задачи</h1>
        <form id="createTaskForm">
            <div class="form-group">
                <label for="summary">Тема задачи (кратко)<span class="required-star">*</span></label>
                <input type="text" id="summary" name="summary" required>
            </div>

            <div class="form-group">
                <label for="configuration">Конфигурация</label>
                <select id="configuration" name="configurationCode">
                    <option value="">-- Выберите конфигурацию --</option>
                    </select>
                <small id="configInfo"></small>
            </div>

            <div class="form-group">
                <label for="details">Детальное описание</label>
                <textarea id="details" name="details"></textarea>
            </div>

            <div class="form-group">
                 <label for="taskFile">Прикрепить файл (до 30МБ)</label>
            <div id="dropZone" class="drop-zone">
                <span class="drop-zone-prompt">Перетащите файл сюда или <u>кликните для выбора</u></span>
                <input type="file" id="taskFile" name="taskFile" class="drop-zone-input">
            </div>
            <div id="fileNameDisplay" class="file-name-display"></div>

           
            <button type="submit" class="button-primary submit-button">Создать задачу</button>
        </form>
        <div id="formMessage" class="message"></div>
        <a href="tasks.html" class="back-link"><i class="fas fa-arrow-left"></i> К списку задач</a> 
    </div>
<body>

 <script>
    let currentFileForUpload = null; // Глобальная переменная для хранения выбранного файла

    window.onload = function() {
        const userCode = localStorage.getItem('userCode');
        if (!userCode) {
            alert("Ошибка: Код пользователя не найден. Пожалуйста, войдите снова.");
            window.location.href = 'index.html';
            return;
        }
        loadClientConfigurations(userCode);
        setupDragAndDrop();
        setupPasteListener(); // Настройка слушателя вставки из буфера
    };

    async function loadClientConfigurations(userCode) {
        const selectElement = document.getElementById('configuration');
        const configInfoElement = document.getElementById('configInfo');
        if (selectElement) selectElement.disabled = true;
        if (configInfoElement) {
            configInfoElement.textContent = 'Загрузка конфигураций...';
            configInfoElement.style.display = 'block';
        }

        try {
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/clientconfigurations/${userCode}`);
            if (!response.ok) {
                throw new Error(`Ошибка загрузки конфигураций: ${response.status}`);
            }
            const configurations = await response.json();

            if (selectElement && configInfoElement) {
                if (configurations && configurations.length > 0) {
                    selectElement.innerHTML = '<option value="">-- Выберите конфигурацию --</option>';
                    configurations.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.code;
                        option.textContent = config.name;
                        selectElement.appendChild(option);
                    });
                    if (configurations.length === 1) {
                        selectElement.value = configurations[0].code;
                        configInfoElement.textContent = 'Конфигурация выбрана автоматически.';
                    } else {
                        configInfoElement.textContent = 'Выберите конфигурацию, если задача к ней относится.';
                    }
                    selectElement.disabled = false;
                } else {
                    configInfoElement.textContent = 'Доступных конфигураций не найдено. Можно создать задачу без указания конфигурации.';
                    selectElement.innerHTML = '<option value="">-- Конфигурации не найдены --</option>';
                    selectElement.disabled = true;
                }
            }
        } catch (error) {
            console.error('Ошибка при загрузке конфигураций:', error);
            if (configInfoElement) configInfoElement.textContent = 'Не удалось загрузить конфигурации.';
            if (selectElement) selectElement.disabled = true;
        }
    }
    
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    // Функция для отображения информации о файле и управления ссылкой на удаление
    function updateFileInfoAndResetInput(fileNameToDisplay) {
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const dropZonePrompt = document.querySelector('#dropZone .drop-zone-prompt');
        const taskFileInput = document.getElementById('taskFile');

        if (dropZonePrompt) dropZonePrompt.style.display = 'none';
        if (fileNameDisplay) {
            fileNameDisplay.innerHTML = `Выбран файл: <strong>${escapeHTML(fileNameToDisplay)}</strong> <a href="#" id="removeFileLink" class="remove-file-link" title="Удалить файл">&times;</a>`;
            fileNameDisplay.style.display = 'block';

            const removeFileLink = document.getElementById('removeFileLink');
            if (removeFileLink) {
                // Удаляем старый обработчик, если он был, чтобы избежать дублирования
                const newRemoveFileLink = removeFileLink.cloneNode(true);
                removeFileLink.parentNode.replaceChild(newRemoveFileLink, removeFileLink);
                
                newRemoveFileLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentFileForUpload = null;
                    if (taskFileInput) taskFileInput.value = ''; 
                    if (fileNameDisplay) fileNameDisplay.style.display = 'none';
                    if (dropZonePrompt) dropZonePrompt.style.display = 'block';
                });
            }
        }
    }

    function setupDragAndDrop() {
        const dropZone = document.getElementById('dropZone');
        const taskFileInput = document.getElementById('taskFile');

        if (!dropZone || !taskFileInput) return;

        dropZone.addEventListener('click', (e) => {
            if (e.target.id === 'removeFileLink') {
                return;
            }
            taskFileInput.click();
        });

        taskFileInput.addEventListener('change', () => {
            if (taskFileInput.files.length > 0) {
                currentFileForUpload = taskFileInput.files[0];
                updateFileInfoAndResetInput(currentFileForUpload.name);
            } else {
                // Это условие может сработать, если пользователь отменил выбор файла в диалоге
                // или если taskFileInput.value был очищен программно и currentFileForUpload уже null
                if (!currentFileForUpload) { 
                    const fileNameDisplay = document.getElementById('fileNameDisplay');
                    const dropZonePrompt = document.querySelector('#dropZone .drop-zone-prompt');
                    if (fileNameDisplay) fileNameDisplay.style.display = 'none';
                    if (dropZonePrompt) dropZonePrompt.style.display = 'block';
                }
            }
        });

        dropZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length > 0) {
                currentFileForUpload = e.dataTransfer.files[0]; 
                // taskFileInput.files = e.dataTransfer.files; // Это присвоение безопасно и полезно
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(currentFileForUpload);
                taskFileInput.files = dataTransfer.files;

                updateFileInfoAndResetInput(currentFileForUpload.name);
            }
        });
    }
    
    function setupPasteListener() {
        const dropZone = document.getElementById('dropZone');
        const taskFileInput = document.getElementById('taskFile');

        if (!taskFileInput) return; // Если нет инпута файла, нет смысла

        document.addEventListener('paste', (event) => {
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' && activeElement.type !== 'file' || activeElement.tagName === 'TEXTAREA')) {
                return; 
            }

            const items = (event.clipboardData || window.clipboardData)?.items;
            if (!items) return;

            let imageFile = null;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    imageFile = items[i].getAsFile();
                    break;
                }
            }

            if (imageFile) {
                event.preventDefault(); 
                console.log('Изображение из буфера обмена получено:', imageFile);

                const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0, 14); // ГГГГММДДЧЧММСС
                const extension = imageFile.type.split('/')[1] || 'png';
                const fileName = `clipboard-${timestamp}.${extension}`;
                
                currentFileForUpload = new File([imageFile], fileName, {type: imageFile.type});
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(currentFileForUpload);
                taskFileInput.files = dataTransfer.files;

                updateFileInfoAndResetInput(currentFileForUpload.name); 
                
                if(dropZone) { 
                    dropZone.classList.add('drag-over'); 
                    setTimeout(() => {
                        dropZone.classList.remove('drag-over');
                    }, 200);
                }
            }
        });
    }

    const createTaskForm = document.getElementById('createTaskForm');
    if (createTaskForm) {
        createTaskForm.addEventListener('submit', async function(event) {
            event.preventDefault(); 

            const formMessageDiv = document.getElementById('formMessage');
            if(formMessageDiv) {
                formMessageDiv.style.display = 'none';
                formMessageDiv.className = 'message'; 
            }

            const userCode = localStorage.getItem('userCode');
            const summaryInput = document.getElementById('summary');
            const detailsInput = document.getElementById('details');
            const configurationSelect = document.getElementById('configuration');

            const summary = summaryInput ? summaryInput.value : '';
            const details = detailsInput ? detailsInput.value : '';
            const configurationCode = configurationSelect ? configurationSelect.value : '';
            
            if (!summary.trim()) {
                if (formMessageDiv) {
                    formMessageDiv.textContent = 'Пожалуйста, укажите тему задачи.';
                    formMessageDiv.classList.add('error');
                    formMessageDiv.style.display = 'block';
                }
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            if(submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Обработка...';
            }

            let attachedFileId = "";
            let attachedFileName = "";

            try {
                if (currentFileForUpload) {
                    if(submitButton) submitButton.textContent = 'Загрузка файла...';
                    
                    const fileUploadResponse = await fetch('https://1c.c-r.kz/Registrator_test/hs/auth/files/upload', {
                        method: 'POST',
                        body: currentFileForUpload, 
                        headers: {
                            'X-File-Name': encodeURIComponent(currentFileForUpload.name) 
                        }
                    });

                    if (!fileUploadResponse.ok) {
                        let errorMsg = `Ошибка загрузки файла: ${fileUploadResponse.status}`;
                        try {
                            const errorData = await fileUploadResponse.json();
                            errorMsg = errorData.message || errorMsg;
                        } catch (e) { /* не JSON */ }
                        throw new Error(errorMsg);
                    }

                    const fileResult = await fileUploadResponse.json();
                    if (fileResult.success) {
                        attachedFileId = fileResult.tempFileId;
                        attachedFileName = fileResult.fileName; 
                        console.log('Файл успешно загружен:', fileResult);
                    } else {
                        throw new Error(fileResult.message || 'Не удалось загрузить файл.');
                    }
                }

                if(submitButton) submitButton.textContent = 'Создание задачи...';
                const taskData = {
                    userCode: userCode,
                    summary: summary,
                    details: details,
                    configurationCode: configurationCode || "" 
                };

                if (attachedFileId) {
                    taskData.attachedFileId = attachedFileId;
                    taskData.attachedFileName = attachedFileName; 
                }

                const taskCreateResponse = await fetch('https://1c.c-r.kz/Registrator_test/hs/auth/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taskData)
                });

                if (!taskCreateResponse.ok) {
                    let errorMsg = `Ошибка создания задачи: ${taskCreateResponse.status}`;
                    try {
                        const errorData = await taskCreateResponse.json();
                        errorMsg = errorData.message || errorMsg;
                    } catch (e) { /* не JSON */ }
                    throw new Error(errorMsg);
                }

                const taskResult = await taskCreateResponse.json();

                if (taskResult.success) {
                    if(formMessageDiv) {
                        formMessageDiv.textContent = `Задача №${taskResult.taskNumber} успешно создана!`;
                        formMessageDiv.classList.add('success');
                    }
                    if(createTaskForm) createTaskForm.reset(); 
                    
                    currentFileForUpload = null; 
                    const taskFileInput = document.getElementById('taskFile');
                    if(taskFileInput) taskFileInput.value = ''; 
                    const fileNameDisplay = document.getElementById('fileNameDisplay');
                    if(fileNameDisplay) fileNameDisplay.style.display = 'none';
                    const dropZonePrompt = document.querySelector('#dropZone .drop-zone-prompt');
                    if(dropZonePrompt) dropZonePrompt.style.display = 'block';

                    setTimeout(() => {
                       window.location.href = 'tasks.html';
                    }, 2500);
                } else {
                    throw new Error(taskResult.message || 'Неизвестная ошибка при создании задачи.');
                }

            } catch (error) {
                console.error('Ошибка при создании задачи с файлом:', error);
                if(formMessageDiv) {
                    formMessageDiv.textContent = 'Ошибка: ' + error.message;
                    formMessageDiv.classList.add('error');
                }
            } finally {
                if(formMessageDiv) formMessageDiv.style.display = 'block';
                if(submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Создать задачу';
                }
            }
        });
    }
</script>
</body>
</html>
