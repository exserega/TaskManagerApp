<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали задачи</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css"> 
    
    </head>
<body class="task-details-page"> 
    <div class="container">
        <div class="page-header">
            <h1 id="task-title">Загрузка данных задачи...</h1>
            <a href="tasks.html" class="back-link-header"><i class="fas fa-arrow-left"></i> К списку задач</a>
        </div>

        <div class="task-chat-wrapper">
            <div class="task-details-section">
                <h2>Детали задачи</h2>
                <div id="task-details-content">
                    <div class="loading-spinner">Загрузка деталей...</div>
                </div>

                <h2>Прикрепленные файлы</h2>
                <ul class="attached-files-list" id="attached-files">
                    <li><i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...</li>
                </ul>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages-area">
                    <div class="message-bubble received">
                        <div class="message-content"><p>Здравствуйте! Уточните, пожалуйста, номер документа, который не проводится.</p></div>
                        <span class="message-timestamp">10:32</span>
                    </div>
                    <div class="message-bubble sent">
                        <div class="message-content"><p>Добрый день! Документ РТУ00-00567 от 14.05.2025.</p></div>
                        <span class="message-timestamp">10:35</span>
                    </div>
                     <div class="message-bubble received">
                        <div class="message-content"><p>Спасибо, принял в работу. Постараюсь разобраться в ближайшее время.</p></div>
                        <span class="message-timestamp">10:38</span>
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="chat-message-input" placeholder="Введите сообщение..." rows="1"></textarea>
                    <button id="chat-send-button" class="chat-send-button" title="Отправить">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const taskId = localStorage.getItem('currentTaskId');
        const taskNumberFromStorage = localStorage.getItem('currentTaskNumber');

        const taskTitleElement = document.getElementById('task-title');
        const taskDetailsContentElement = document.getElementById('task-details-content');
        const attachedFilesListElement = document.getElementById('attached-files');
        
        const chatMessageInputElement = document.getElementById('chat-message-input');
        const chatSendButtonElement = document.getElementById('chat-send-button');

        // Установка заголовка страницы
        if (taskNumberFromStorage) {
            taskTitleElement.textContent = `Задача №${taskNumberFromStorage}`;
        } else if (taskId) {
            taskTitleElement.textContent = `Задача (ID: ${taskId.substring(0,8)}...)`;
        } else {
            taskTitleElement.textContent = 'Детали задачи';
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="error-message-placeholder">Ошибка: ID задачи не найден. Вернитесь к списку задач.</div>';
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Не удалось загрузить файлы.</li>';
            if(chatMessageInputElement) chatMessageInputElement.disabled = true;
            if(chatSendButtonElement) chatSendButtonElement.disabled = true;
            return;
        }

        if (!taskId) { 
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="error-message-placeholder">Ошибка: ID задачи не определен.</div>';
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Не удалось загрузить файлы.</li>';
            if(chatMessageInputElement) chatMessageInputElement.disabled = true;
            if(chatSendButtonElement) chatSendButtonElement.disabled = true;
            return;
        }

        if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="loading-spinner">Загрузка деталей задачи...</div>';
        if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...</li>';

        try {
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/task/${taskId}`); 
            
            if (!response.ok) {
                let errorMsg = `Ошибка ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message ? `${errorData.message} (статус ${response.status})` : errorMsg;
                } catch (e) { 
                    errorMsg = `Ошибка ${response.status}: ${response.statusText}`;
                }
                throw new Error(`Не удалось загрузить данные задачи. ${errorMsg}`);
            }

            const result = await response.json();

            if (result.success && result.task) {
                displayTaskDetails(result.task);
                // === ВЫЗОВ ЗАГРУЗКИ СООБЩЕНИЙ ЧАТА ===
                loadChatMessages(taskId); // <--- УБЕДИТЕСЬ, ЧТО ЭТА СТРОКА РАСКОММЕНТИРОВАНА И ВЫЗЫВАЕТСЯ
            } else {
                throw new Error(result.message || 'Получены некорректные данные о задаче от сервера.');
            }

        } catch (error) {
            console.error('Ошибка при загрузке деталей задачи:', error);
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = `<div class="error-message-placeholder">Ошибка при загрузке деталей: ${error.message}</div>`;
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Ошибка загрузки списка файлов.</li>';
        }

        if (chatMessageInputElement) {
            chatMessageInputElement.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }
    });

    function displayTaskDetails(task) {
        // ... (ваш код displayTaskDetails без изменений) ...
        // Убедитесь, что этот код работает и детали отображаются.
        // Я его не повторяю здесь для краткости.
        const taskDetailsContentElement = document.getElementById('task-details-content');
        const attachedFilesListElement = document.getElementById('attached-files');
        const taskTitleElement = document.getElementById('task-title'); 
        
        if (task.number && taskTitleElement) {
            taskTitleElement.textContent = `Задача №${task.number}`;
        }

        let formattedDate = task.date;
        if (task.date) {
            try {
                const dateStringForJS = task.date.replace('Т', ' ');
                const dateObj = new Date(dateStringForJS);
              if (!isNaN(dateObj.getTime())) { 
    let hours = dateObj.getHours();
    let minutes = dateObj.getMinutes();

    // Добавляем ведущий ноль, если нужно
    let hoursFormatted = hours < 10 ? '0' + hours : hours.toString();
    let minutesFormatted = minutes < 10 ? '0' + minutes : minutes.toString();

    formattedTimestamp = `${hoursFormatted}:${minutesFormatted}`;
    console.log("Formatted timestamp (manual):", formattedTimestamp); // <--- НОВЫЙ ОТЛАДОЧНЫЙ ВЫВОД
} else {
                    console.warn("Не удалось распознать дату задачи:", task.date);
                    formattedDate = task.date;
                }
            } catch (e) { 
                console.error("Ошибка форматирования даты задачи:", e); 
                formattedDate = task.date;
            }
        }
        
        let statusClass = 'status-default';
        if (task.status) {
            const statusNormalized = String(task.status).toLowerCase().replace(/\s+/g, '-');
            if (statusNormalized.includes('новая')) statusClass = 'status-new';
            else if (statusNormalized.includes('в-работе') || statusNormalized.includes('в работе')) statusClass = 'status-in-progress';
            else if (statusNormalized.includes('выполнена') || statusNormalized.includes('завершена')) statusClass = 'status-completed';
            else if (statusNormalized.includes('согласование-оценки')) statusClass = 'status-согласование-оценки';
            else if (statusNormalized.includes('ожидает-ответа-клиента')) statusClass = 'status-ожидает-ответа-клиента';
        }

        let detailsHTML = `
            <div class="detail-item"><strong>Номер:</strong> <span>${task.number || 'не указан'}</span></div>
            <div class="detail-item"><strong>Дата:</strong> <span>${formattedDate || 'не указана'}</span></div>
            <div class="detail-item"><strong>Статус:</strong> <span class="task-status-detail ${statusClass}">${task.status || 'не определен'}</span></div>
            ${task.configurationName ? `<div class="detail-item"><strong>Конфигурация:</strong> <span>${task.configurationName}</span></div>` : ''}
            <div class="detail-item"><strong>Тема:</strong> <span>${task.summary || 'без темы'}</span></div>
            <div class="detail-item"><strong>Описание:</strong><br><span>${(task.details || 'нет описания').replace(/\n/g, '<br>')}</span></div>
        `;
        if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = detailsHTML;

        if (task.files && task.files.length > 0) {
            let filesHTML = '';
            task.files.forEach(file => {
                filesHTML += `<li><a href="#" data-file-guid="${file.file_guid || ''}" class="task-file-link" title="Файл: ${file.name}"><i class="fas fa-paperclip"></i> ${file.name}</a></li>`;
            });
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = filesHTML;
        } else {
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Прикрепленных файлов нет.</li>';
        }
    }


    // === ФУНКЦИИ ДЛЯ ЧАТА ===
    async function loadChatMessages(taskId) {
        const chatMessagesAreaElement = document.getElementById('chat-messages-area');
        if (!chatMessagesAreaElement) {
            console.error("Элемент #chat-messages-area не найден для отображения сообщений!");
            return;
        }

        const userCode = localStorage.getItem('userCode'); // Получаем userCode текущего клиента
        console.log("loadChatMessages: userCode из localStorage:", userCode); // <--- ОТЛАДОЧНЫЙ ВЫВОД

        if (!userCode) {
            console.warn("UserCode не найден в localStorage, заголовок X-User-Code не будет отправлен. Поле isOwn для сообщений чата будет определено как 'не мое'.");
        }

        // Очищаем предыдущие сообщения или заглушку "загрузка"
        chatMessagesAreaElement.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Загрузка сообщений...</div>'; 

        try {
            const headers = {
                // 'Content-Type': 'application/json' // Для GET-запроса обычно не нужен
            };
            if (userCode) {
                headers['X-User-Code'] = userCode; // Добавляем заголовок, если userCode есть
            }
            console.log("loadChatMessages: Отправляемые заголовки:", headers); // <--- ОТЛАДОЧНЫЙ ВЫВОД

            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/messages`, {
                method: 'GET',
                headers: headers
            });

            if (!response.ok) {
                let errorMsg = `Ошибка ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message ? `${errorData.message} (статус ${response.status})` : errorMsg;
                } catch (e) { 
                    errorMsg = `Ошибка ${response.status}: ${response.statusText}`;
                }
                throw new Error(`Не удалось загрузить сообщения чата. ${errorMsg}`);
            }

            const result = await response.json();

            if (result.success && result.messages) {
                chatMessagesAreaElement.innerHTML = ''; 
                if (result.messages.length === 0) {
                    const noMessagesDiv = document.createElement('div');
                    noMessagesDiv.style.textAlign = 'center';
                    noMessagesDiv.style.color = '#6c757d';
                    noMessagesDiv.style.padding = '20px';
                    noMessagesDiv.textContent = 'В этом чате пока нет сообщений.';
                    chatMessagesAreaElement.appendChild(noMessagesDiv);
                } else {
                    result.messages.forEach(message => {
                        displayChatMessage(message);
                    });
                    chatMessagesAreaElement.scrollTop = chatMessagesAreaElement.scrollHeight; 
                }
            } else {
                throw new Error(result.message || 'Получены некорректные данные сообщений от сервера.');
            }

        } catch (error) {
            console.error('Ошибка при загрузке сообщений чата:', error);
            if (chatMessagesAreaElement) {
                chatMessagesAreaElement.innerHTML = `<div class="error-message-placeholder" style="text-align:center;">Ошибка загрузки сообщений: ${error.message}</div>`;
            }
        }
    }

    Вы абсолютно правы! Прошу прощения за то, что снова использовал сокращенный вариант. Это моя привычка стараться не повторять уже написанный код, но для вас это неудобно.

Давайте я предоставлю полный код функции displayChatMessage с исправлением для форматирования времени, без каких-либо сокращений или комментариев типа "// ... (код остается без изменений) ...".

Вот как должна выглядеть вся функция displayChatMessage в вашем файле task-details.html внутри тега <script>:

JavaScript

function displayChatMessage(message) {
    const chatMessagesAreaElement = document.getElementById('chat-messages-area');
    if (!chatMessagesAreaElement) {
        console.error("Элемент #chat-messages-area не найден для displayChatMessage!"); // Добавим лог ошибки
        return;
    }

    // Если первое, что мы добавляем, и это "Загрузка...", то очищаем перед добавлением реального сообщения
    const firstChild = chatMessagesAreaElement.firstChild;
    if (firstChild && firstChild.nodeType === Node.ELEMENT_NODE && firstChild.querySelector('i.fa-spinner')) {
         chatMessagesAreaElement.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message-bubble');
    
    if (message.isOwn) { 
        messageDiv.classList.add('sent');
    } else {
        messageDiv.classList.add('received');
    }

    let formattedTimestamp = '--:--'; // Значение по умолчанию
    // console.log("Processing message timestamp:", message.timestamp); // Можно оставить для детальной отладки

    if (message.timestamp) {
        try {
            const dateStringForJS = message.timestamp.replace('Т', ' ');
            // console.log("Date string for JS:", dateStringForJS); // Для отладки

            const dateObj = new Date(dateStringForJS);
            // console.log("Created dateObj:", dateObj, "Is Valid:", !isNaN(dateObj.getTime())); // Для отладки

            if (!isNaN(dateObj.getTime())) { 
                // Ручное форматирование времени ЧЧ:ММ
                let hours = dateObj.getHours();
                let minutes = dateObj.getMinutes();

                let hoursFormatted = hours < 10 ? '0' + hours : hours.toString();
                let minutesFormatted = minutes < 10 ? '0' + minutes : minutes.toString();

                formattedTimestamp = `${hoursFormatted}:${minutesFormatted}`;
                // console.log("Formatted message timestamp (manual):", formattedTimestamp); // Для отладки
            } else {
                 console.warn("Не удалось распознать время сообщения (объект Date невалиден) для строки:", message.timestamp);
                 // Попытка извлечь время из строки, если объект Date невалиден
                 const timePartMatch = message.timestamp.match(/(\d{2}:\d{2})(:\d{2})?$/); // Ищем ЧЧ:ММ или ЧЧ:ММ:СС в конце строки
                 if (timePartMatch && timePartMatch[1]) {
                     formattedTimestamp = timePartMatch[1]; // Берем ЧЧ:ММ
                 }
            }
        } catch (e) { 
            console.warn("Ошибка при форматировании времени сообщения:", message.timestamp, e); 
            const timePartMatch = message.timestamp.match(/(\d{2}:\d{2})(:\d{2})?$/);
            if (timePartMatch && timePartMatch[1]) {
                formattedTimestamp = timePartMatch[1];
            }
        }
    }
    
    messageDiv.innerHTML = `
        <div class="message-content"><p>${(message.text || '').replace(/\n/g, '<br>')}</p></div>
        <span class="message-timestamp">${formattedTimestamp}</span>
    `;
    chatMessagesAreaElement.appendChild(messageDiv);
}

</script>
</body>
</html>
