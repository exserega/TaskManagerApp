<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали задачи</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css"> 
    
    </head>
<body class="task-details-page"> 
    <div class="container">
        <div class="page-header">
            <h1 id="task-title">Загрузка данных задачи...</h1>
            <a href="tasks.html" class="back-link-header"><i class="fas fa-arrow-left"></i> К списку задач</a>
        </div>

        <div class="task-chat-wrapper">
            <div class="task-details-section">
                <h2>Детали задачи</h2>
                <div id="task-details-content">
                    <div class="loading-spinner">Загрузка деталей...</div>
                </div>

                <h2>Прикрепленные файлы</h2>
                <ul class="attached-files-list" id="attached-files">
                    <li><i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...</li>
                </ul>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages-area">
                    <div class="message-bubble received">
                        <div class="message-content"><p>Здравствуйте! Уточните, пожалуйста, номер документа, который не проводится.</p></div>
                        <span class="message-timestamp">10:32</span>
                    </div>
                    <div class="message-bubble sent">
                        <div class="message-content"><p>Добрый день! Документ РТУ00-00567 от 14.05.2025.</p></div>
                        <span class="message-timestamp">10:35</span>
                    </div>
                     <div class="message-bubble received">
                        <div class="message-content"><p>Спасибо, принял в работу. Постараюсь разобраться в ближайшее время.</p></div>
                        <span class="message-timestamp">10:38</span>
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="chat-message-input" placeholder="Введите сообщение..." rows="1"></textarea>
                    <button id="chat-send-button" class="chat-send-button" title="Отправить">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const taskId = localStorage.getItem('currentTaskId');
        const taskNumberFromStorage = localStorage.getItem('currentTaskNumber'); // Уже используется для заголовка

        const taskTitleElement = document.getElementById('task-title');
        const taskDetailsContentElement = document.getElementById('task-details-content');
        const attachedFilesListElement = document.getElementById('attached-files');
        
        // Элементы для чата (пока только для блокировки)
        const chatMessageInputElement = document.getElementById('chat-message-input');
        const chatSendButtonElement = document.getElementById('chat-send-button');

        // Установка заголовка страницы
        if (taskNumberFromStorage) {
            taskTitleElement.textContent = `Задача №${taskNumberFromStorage}`;
        } else if (taskId) {
            taskTitleElement.textContent = `Задача (ID: ${taskId.substring(0,8)}...)`; // Показываем часть ID, если номера нет
        } else {
            taskTitleElement.textContent = 'Детали задачи';
            // Сообщаем об ошибке и блокируем дальнейшие действия, если нет ID
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="error-message-placeholder">Ошибка: ID задачи не найден. Вернитесь к списку задач.</div>';
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Не удалось загрузить файлы.</li>';
            if(chatMessageInputElement) chatMessageInputElement.disabled = true;
            if(chatSendButtonElement) chatSendButtonElement.disabled = true;
            return;
        }

        // Дополнительная проверка, если taskId оказался пустым после localStorage.getItem
        if (!taskId) { 
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="error-message-placeholder">Ошибка: ID задачи не определен.</div>';
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Не удалось загрузить файлы.</li>';
            if(chatMessageInputElement) chatMessageInputElement.disabled = true;
            if(chatSendButtonElement) chatSendButtonElement.disabled = true;
            return;
        }

        // Показываем спиннеры/сообщения о загрузке
        if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="loading-spinner">Загрузка деталей задачи...</div>';
        if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...</li>';

        try {
            // === Загрузка деталей задачи ===
            // Убедитесь, что URL правильный и соответствует вашему HTTP-сервису в 1С
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/task/${taskId}`); 
            
            if (!response.ok) {
                let errorMsg = `Ошибка ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message ? `${errorData.message} (статус ${response.status})` : errorMsg;
                } catch (e) { 
                    errorMsg = `Ошибка ${response.status}: ${response.statusText}`;
                }
                throw new Error(`Не удалось загрузить данные задачи. ${errorMsg}`);
            }

            const result = await response.json();

            if (result.success && result.task) {
                displayTaskDetails(result.task);
                // loadChatMessages(taskId); // Эту функцию мы реализуем на следующем этапе
            } else {
                throw new Error(result.message || 'Получены некорректные данные о задаче от сервера.');
            }

        } catch (error) {
            console.error('Ошибка при загрузке деталей задачи:', error);
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = `<div class="error-message-placeholder">Ошибка при загрузке деталей: ${error.message}</div>`;
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Ошибка загрузки списка файлов.</li>';
        }

        // Динамическое изменение высоты textarea (этот код у вас уже был, оставляем)
        if (chatMessageInputElement) {
            chatMessageInputElement.addEventListener('input', function() {
                this.style.height = 'auto'; // Сбрасываем высоту
                this.style.height = (this.scrollHeight) + 'px'; // Устанавливаем по содержимому
            });
        }
    });

    function displayTaskDetails(task) {
        const taskDetailsContentElement = document.getElementById('task-details-content');
        const attachedFilesListElement = document.getElementById('attached-files');
        const taskTitleElement = document.getElementById('task-title'); 
        
        if (task.number && taskTitleElement) { // Обновляем заголовок с номером из полученных данных
            taskTitleElement.textContent = `Задача №${task.number}`;
        }

        let formattedDate = task.date; // Дата должна приходить в формате, который new Date() сможет распознать, например ISO 8601
        if (task.date) {
            try {
                const dateObj = new Date(task.date);
                if (!isNaN(dateObj.getTime())) {
                    formattedDate = dateObj.toLocaleString('ru-RU', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                } else {
                    console.warn("Не удалось распознать дату задачи:", task.date);
                    formattedDate = task.date; // Показать как есть, если не распознана
                }
            } catch (e) { 
                console.error("Ошибка форматирования даты задачи:", e); 
                formattedDate = task.date; // Показать как есть в случае ошибки
            }
        }
        
        let statusClass = 'status-default';
        if (task.status) {
            const statusNormalized = String(task.status).toLowerCase().replace(/\s+/g, '-');
            if (statusNormalized.includes('новая')) statusClass = 'status-new';
            else if (statusNormalized.includes('в-работе') || statusNormalized.includes('в работе')) statusClass = 'status-in-progress';
            // Добавьте здесь другие ваши статусы для корректного отображения класса
            else if (statusNormalized.includes('выполнена') || statusNormalized.includes('завершена')) statusClass = 'status-completed';
            else if (statusNormalized.includes('согласование-оценки')) statusClass = 'status-согласование-оценки';
            else if (statusNormalized.includes('ожидает-ответа-клиента')) statusClass = 'status-ожидает-ответа-клиента';
        }

        let detailsHTML = `
            <div class="detail-item"><strong>Номер:</strong> <span>${task.number || 'не указан'}</span></div>
            <div class="detail-item"><strong>Дата:</strong> <span>${formattedDate || 'не указана'}</span></div>
            <div class="detail-item"><strong>Статус:</strong> <span class="task-status-detail ${statusClass}">${task.status || 'не определен'}</span></div>
            ${task.configurationName ? `<div class="detail-item"><strong>Конфигурация:</strong> <span>${task.configurationName}</span></div>` : ''}
            <div class="detail-item"><strong>Тема:</strong> <span>${task.summary || 'без темы'}</span></div>
            <div class="detail-item"><strong>Описание:</strong><br><span>${(task.details || 'нет описания').replace(/\n/g, '<br>')}</span></div>
        `;
        if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = detailsHTML;

        // Отображение файлов
        if (task.files && task.files.length > 0) {
            let filesHTML = '';
            task.files.forEach(file => {
                // file_guid будет использоваться для формирования ссылки на скачивание позже
                filesHTML += `<li><a href="#" data-file-guid="${file.file_guid || ''}" class="task-file-link" title="Файл: ${file.name}"><i class="fas fa-paperclip"></i> ${file.name}</a></li>`;
            });
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = filesHTML;
        } else {
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Прикрепленных файлов нет.</li>';
        }
    }

    // Вспомогательная функция для форматирования размера файла (если будете передавать размер)
    /*
    function formatFileSize(bytes, decimals = 2) {
        if (!+bytes) return '0 байт'; // Используем +bytes для преобразования в число, если это строка
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['байт', 'КБ', 'МБ', 'ГБ', 'ТБ'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    */

    // Функции для чата будут добавлены здесь позже:
    // async function loadChatMessages(taskId) { /* ... */ }
    // document.getElementById('chat-send-button').addEventListener('click', async () => { /* ... */ });
</script>
</body>
</html>
