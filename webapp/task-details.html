<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Детали задачи</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <link rel="stylesheet" href="styles.css"> 
    
    </head>
<body class="task-details-page"> 
    <div class="container">
        <div class="page-header">
    <a href="tasks.html" class="back-link-header"><i class="fas fa-arrow-left"></i> К списку задач</a> 
    <h1 id="task-title">Загрузка данных задачи...</h1>
</div>

       <div class="task-chat-wrapper">
    <div class="task-details-section">
        <h2>Детали задачи</h2>
        <div id="task-details-content">
            </div>

        <div id="taskDetailActionsPlaceholder" class="task-detail-actions-container" style="margin-top: 20px; margin-bottom: 20px;">
            </div>



        <h2>Прикрепленные файлы</h2>
        <div class="expandable-file-list-container">
            <ul class="attached-files-list" id="attached-files">
                <li><i class="fas fa-spinner fa-spin"></i> Загрузка списка файлов...</li>
            </ul>
            <button id="toggle-files-btn" class="toggle-files-button" style="display:none;">Показать все</button>
        </div>
		
		<h2>История статусов</h2>
                <div id="taskStatusHistoryContainer">
                    <p>Загрузка истории статусов...</p>
                </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chat-messages-area">
           
        </div>
        <div class="chat-input-area">
            <button id="chat-attach-file-button" class="chat-attach-button" title="Прикрепить файл">
                <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="chat-file-input" style="display: none;">
            <textarea id="chat-message-input" placeholder="Введите сообщение..." rows="1"></textarea>
            <button id="chat-send-button" class="chat-send-button" title="Отправить">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div id="chat-selected-file-info" class="selected-file-info" style="display: none;">
            Выбран файл: <span id="selected-file-name"></span>
            <button id="chat-remove-selected-file" class="remove-file-button" title="Удалить файл">&times;</button>
        </div>
    </div>
	
	
	<div id="customAlertOverlay" class="custom-alert-overlay" style="display: none;">
    <div class="custom-alert-box">
        <p id="customAlertMessage"></p>
        <button id="customAlertOkButton">OK</button>
    </div>
</div>


</div> <div id="reworkCommentModalDetails" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>Отправка задачи на доработку</h3>
        <p>Пожалуйста, укажите причину отправки задачи на доработку. Этот комментарий будет добавлен в чат по задаче.</p>
        <textarea id="reworkCommentTextareaDetails" class="modal-comment-textarea" placeholder="Введите ваш комментарий..." rows="4"></textarea>

        <div class="form-group" style="margin-top: 15px; margin-bottom: 10px;">
            <label for="reworkFileDetailsPageInput">Прикрепить файл (1 шт.)</label>
            <div id="dropZoneReworkDetailsPage" class="drop-zone" style="padding: 15px 10px; min-height: 50px;">
                <span class="drop-zone-prompt" style="font-size: 0.9em;">Перетащите файл сюда или <u>кликните для выбора</u></span>
<input type="file" id="ReworkDetailsPageInput" class="drop-zone-input" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar">
            <div id="fileNameDisplayReworkDetailsPage" class="file-name-display" style="margin-top: 5px; font-size: 0.85em;">
                </div>
            <div id="imagePreviewReworkDetailsPage" class="image-previews-container" style="margin-top: 10px; display: flex; justify-content: center; max-height: 80px;">
                </div>
        </div>
        <div class="modal-actions">
            <button id="submitReworkCommentBtnDetails" class="button-primary">Отправить</button>
            <button id="cancelReworkCommentBtnDetails" class="button-secondary">Отмена</button>
        </div>
    </div>
</div>
</div>
 <script>
    // Глобальные переменные для чата и файлов
    let chatUpdateIntervalId = null;
    const CHAT_UPDATE_INTERVAL = 5000; 
    let currentSelectedFile = null; 
    let currentOpenTaskId = null;
    let currentReworkFileForModal = null;
	
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function displayChatMessage(message) {
        const chatMessagesAreaElement = document.getElementById('chat-messages-area');
        if (!chatMessagesAreaElement) {
            console.error("displayChatMessage: Элемент #chat-messages-area не найден!");
            return;
        }
        const firstChild = chatMessagesAreaElement.firstChild;
        if (firstChild && firstChild.nodeType === Node.ELEMENT_NODE &&
            (firstChild.querySelector('i.fa-spinner') || 
             firstChild.textContent === 'В этом чате пока нет сообщений.' || 
             firstChild.classList.contains('loading-spinner') || 
             firstChild.classList.contains('error-message-placeholder'))) {
            chatMessagesAreaElement.innerHTML = '';
        }
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-bubble');
        if (message.isOwn) {
            messageDiv.classList.add('sent');
        } else {
            messageDiv.classList.add('received');
        }
        let formattedTimestamp = '--:--';
        if (message.timestamp) {
            try {
                const dateStringForJS = message.timestamp.replace('Т', ' ');
                const dateObj = new Date(dateStringForJS);
                if (!isNaN(dateObj.getTime())) {
                    let hours = dateObj.getHours().toString().padStart(2, '0');
                    let minutes = dateObj.getMinutes().toString().padStart(2, '0');
                    formattedTimestamp = `${hours}:${minutes}`;
                } else { 
                    // ИСПРАВЛЕНО РЕГУЛЯРНОЕ ВЫРАЖЕНИЕ ЗДЕСЬ (удален мусор в конце)
                    const timePartMatch = message.timestamp.match(/(\d{2}:\d{2})(:\d{2})?$/);
                    if (timePartMatch && timePartMatch[1]) {
                        formattedTimestamp = timePartMatch[1];
                    }
                }
            } catch (e) { 
                // И И ЗДЕСЬ ТОЖЕ ИСПРАВЛЕНО
                const timePartMatch = message.timestamp.match(/(\d{2}:\d{2})(:\d{2})?$/);
                if (timePartMatch && timePartMatch[1]) {
                    formattedTimestamp = timePartMatch[1];
                }
                console.warn("Ошибка форматирования времени, использован fallback:", message.timestamp, e);
            }
        }
        let fileHTML = '';
        if (message.fileInfo && message.fileInfo.fileName && message.fileInfo.fileId) {
            const downloadUrl = `https://1c.c-r.kz/Registrator_test/hs/auth/chat/downloadfile/${message.fileInfo.fileId}`;
            const safeFileNameForDisplay = escapeHTML(message.fileInfo.fileName);
            fileHTML = `<div class="message-attachment">
                            <i class="fas fa-file-alt"></i>
                            <a href="${downloadUrl}" target="_blank" title="Скачать ${safeFileNameForDisplay}">${safeFileNameForDisplay}</a>
                        </div>`;
        }
        const safeTextForDisplay = escapeHTML(message.text || '').replace(/\n/g, '<br>');
        messageDiv.innerHTML = `
            <div class="message-content">
                <p>${safeTextForDisplay}</p>
                ${fileHTML}
            </div>
            <span class="message-timestamp">${formattedTimestamp}</span>`;
        chatMessagesAreaElement.appendChild(messageDiv);
    }

    function displayTaskDetails(task) {
        const taskDetailsContentElement = document.getElementById('task-details-content');
        const attachedFilesListElement = document.getElementById('attached-files'); 
        const taskTitleElement = document.getElementById('task-title');
        const actionsPlaceholder = document.getElementById('taskDetailActionsPlaceholder');

        if (actionsPlaceholder) {
            actionsPlaceholder.innerHTML = ''; 
        } else {
             console.error("Плейсхолдер для кнопок действий 'taskDetailActionsPlaceholder' не найден!");
        }

        if (task.number && taskTitleElement) {
            taskTitleElement.textContent = `Задача №${escapeHTML(task.number)}`;
        }

        let formattedDate = task.date;
        if (task.date) {
            try {
                const dateStringForJS = task.date.replace('Т', ' ');
                const dateObj = new Date(dateStringForJS);
                if (!isNaN(dateObj.getTime())) {
                    const day = dateObj.getDate().toString().padStart(2, '0');
                    const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    const year = dateObj.getFullYear();
                    const hours = dateObj.getHours().toString().padStart(2, '0');
                    const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                    formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;
                } else { formattedDate = task.date; }
            } catch (e) { formattedDate = task.date; }
        }

        let statusClass = 'status-default';
        let rawTaskStatus = String(task.status || '').trim(); 

        if (rawTaskStatus) {
            const statusNormalizedForClass = rawTaskStatus.toLowerCase().replace(/\s+/g, '-');
            if (statusNormalizedForClass.includes('новая')) statusClass = 'status-new';
            else if (statusNormalizedForClass.includes('в-работе')) statusClass = 'status-in-progress';
            else if (statusNormalizedForClass.includes('на-проверке')) statusClass = 'status-on-check';
            else if (statusNormalizedForClass.includes('выполнена') || statusNormalizedForClass.includes('завершена') || statusNormalizedForClass.includes('закрыта')) statusClass = 'status-completed';
        }

        let detailsHTML = `
            <div class="detail-item"><strong>Номер:</strong> <span>${escapeHTML(task.number) || 'не указан'}</span></div>
            <div class="detail-item"><strong>Дата:</strong> <span>${escapeHTML(formattedDate) || 'не указана'}</span></div>
            <div class="detail-item"><strong>Статус:</strong> <span class="task-status-detail ${statusClass}">${escapeHTML(task.status) || 'не определен'}</span></div>
            ${task.configurationName ? `<div class="detail-item"><strong>Конфигурация:</strong> <span>${escapeHTML(task.configurationName)}</span></div>` : ''}
            <div class="detail-item"><strong>Тема:</strong> <span>${escapeHTML(task.summary) || 'без темы'}</span></div>
            <div class="detail-item"><strong>Описание:</strong><br><span>${escapeHTML(task.details || 'нет описания').replace(/\n/g, '<br>')}</span></div>`;
        if(taskDetailsContentElement) {
            taskDetailsContentElement.innerHTML = detailsHTML;
        }

        if (attachedFilesListElement) {
          if (task.files && task.files.length > 0) {
                let filesHTML = '';
                task.files.forEach(file => {
                    const downloadTaskFileUrl = `https://1c.c-r.kz/Registrator_test/hs/auth/taskfile/${task.id}/${file.file_guid}`;
                    const safeFileName = escapeHTML(file.name);
                    
                    const isLikelyImage = /\.(jpe?g|png|gif|bmp|webp|svg)$/i.test(file.name);
                    const targetAttribute = isLikelyImage ? 'target="_blank"' : '';

                    filesHTML += `<li><a href="${downloadTaskFileUrl}" ${targetAttribute} class="task-file-link" title="Скачать файл ${safeFileName}"><i class="fas fa-paperclip"></i> ${safeFileName}</a></li>`;
                });
                attachedFilesListElement.innerHTML = filesHTML;
                setupExpandableFileList(task.files.length);
            } else {
                attachedFilesListElement.innerHTML = '<li>Прикрепленных файлов нет.</li>';
                const toggleButton = document.getElementById('toggle-files-btn');
                if (toggleButton) toggleButton.style.display = 'none';
            }
        }
        
        if (rawTaskStatus.toLowerCase().replace(/\s+/g, '') === "напроверке" && actionsPlaceholder) { 
            actionsPlaceholder.innerHTML = `
                <button class="task-action-button approve-task-btn-details" data-task-id="${task.id}">Задача выполнена</button>
                <button class="task-action-button rework-task-btn-details" data-task-id="${task.id}">Отправить на доработку</button>
            `;
            const approveBtn = actionsPlaceholder.querySelector('.approve-task-btn-details');
            const reworkBtn = actionsPlaceholder.querySelector('.rework-task-btn-details');

            if (approveBtn) {
                approveBtn.addEventListener('click', function() {
                    handleApproveCompletionOnDetailsPage(this.dataset.taskId);
                });
            }
            if (reworkBtn) {
                reworkBtn.addEventListener('click', function() { 
                    handleRequestReworkOnDetailsPage(this.dataset.taskId);
                });
            }
        }
    }
    
    function setupExpandableFileList(totalFiles) {
        const filesList = document.getElementById('attached-files');
        const toggleButton = document.getElementById('toggle-files-btn');
        const filesToShowByDefault = 3;
        if (!filesList || !toggleButton) return;
        const allFileItems = filesList.querySelectorAll('li');
        if (totalFiles <= filesToShowByDefault) {
            toggleButton.style.display = 'none';
            allFileItems.forEach(item => item.classList.remove('hidden-file'));
            return;
        }
        toggleButton.style.display = 'inline-block';
        let isExpanded = false;
        const toggleButtonClickHandler = () => {
            isExpanded = !isExpanded;
            updateFileListVisibility();
        };
        function updateFileListVisibility() {
            allFileItems.forEach((item, index) => {
                if (isExpanded || index < filesToShowByDefault) {
                    item.classList.remove('hidden-file');
                } else {
                    item.classList.add('hidden-file');
                }
            });
            toggleButton.textContent = isExpanded ? 'Скрыть лишние' : `Показать все (${totalFiles})`;
        }
        if (toggleButton.clickHandlerFunction) { 
            toggleButton.removeEventListener('click', toggleButton.clickHandlerFunction);
        }
        toggleButton.addEventListener('click', toggleButtonClickHandler);
        toggleButton.clickHandlerFunction = toggleButtonClickHandler;
        updateFileListVisibility();
    }

    async function loadChatMessages(taskId, isBackgroundUpdate = false) {
        const chatMessagesAreaElement = document.getElementById('chat-messages-area');
        if (!chatMessagesAreaElement) { return; }
        const userCode = localStorage.getItem('userCode'); 
        if (!isBackgroundUpdate) {
            const currentContent = chatMessagesAreaElement.innerHTML.trim();
            if (currentContent === '' || (chatMessagesAreaElement.firstChild && chatMessagesAreaElement.firstChild.nodeType === Node.ELEMENT_NODE && (chatMessagesAreaElement.firstChild.querySelector('i.fa-spinner') || chatMessagesAreaElement.firstChild.classList.contains('error-message-placeholder') || chatMessagesAreaElement.firstChild.textContent === 'В этом чате пока нет сообщений.'))) {
                 chatMessagesAreaElement.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Загрузка сообщений...</div>';
            }
        }
        let currentClientMessageCount = chatMessagesAreaElement.querySelectorAll('.message-bubble').length;
        if (isBackgroundUpdate && chatMessagesAreaElement.firstChild && (chatMessagesAreaElement.firstChild.textContent === 'В этом чате пока нет сообщений.' || (chatMessagesAreaElement.firstChild.querySelector && chatMessagesAreaElement.firstChild.querySelector('i.fa-spinner')))) {
            currentClientMessageCount = 0;
        }
        try {
            const headers = {};
            if (userCode) { headers['X-User-Code'] = userCode; }
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/messages`, { method: 'GET', headers: headers });
            if (!response.ok) {
                let errorMsg = `Ошибка ${response.status}`;
                try { const errorData = await response.json(); errorMsg = errorData.message ? `${errorData.message} (${response.status})` : errorMsg; } catch (e) { errorMsg = `Ошибка ${response.status}: ${response.statusText}`; }
                if (!isBackgroundUpdate) { throw new Error(`Не удалось загрузить сообщения чата. ${errorMsg}`); } else { console.warn(`Фоновое обновление чата ОШИБКА: ${errorMsg}`); return; }
            }
            const result = await response.json();
            if (result.success && result.messages) {
                const noMessagesCurrentlyDisplayed = chatMessagesAreaElement.firstChild && chatMessagesAreaElement.firstChild.textContent === 'В этом чате пока нет сообщений.';
                const spinnerCurrentlyDisplayed = chatMessagesAreaElement.firstChild && chatMessagesAreaElement.firstChild.querySelector && chatMessagesAreaElement.firstChild.querySelector('i.fa-spinner');
                
                if (!isBackgroundUpdate || result.messages.length !== currentClientMessageCount || noMessagesCurrentlyDisplayed || spinnerCurrentlyDisplayed) {
                    chatMessagesAreaElement.innerHTML = ''; 
                    if (result.messages.length === 0) {
                        const noMessagesDiv = document.createElement('div');
                        noMessagesDiv.style.textAlign = 'center'; noMessagesDiv.style.color = '#6c757d'; noMessagesDiv.style.padding = '20px'; 
                        noMessagesDiv.textContent = 'В этом чате пока нет сообщений.';
                        chatMessagesAreaElement.appendChild(noMessagesDiv);
                    } else {
                        result.messages.forEach(message => displayChatMessage(message)); 
                        if (!isBackgroundUpdate || (result.messages.length > currentClientMessageCount && currentClientMessageCount > 0) || (result.messages.length > 0 && (currentClientMessageCount === 0 || noMessagesCurrentlyDisplayed || spinnerCurrentlyDisplayed) ) ) {
                           chatMessagesAreaElement.scrollTop = chatMessagesAreaElement.scrollHeight;
                        }
                    }
                }
                if (!isBackgroundUpdate && userCode) { 
                    const hasEmployeeMessagesToMark = result.messages.some(msg => msg.senderType === 'Employee' && !msg.isOwn);
                    if (hasEmployeeMessagesToMark || result.messages.length > 0) { 
                        try {
                            fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/markAsReadByClient`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }
                            })
                            .then(markReadResponse => markReadResponse.json().catch(() => ({ success: false, message: `Ошибка сервера: ${markReadResponse.status} ${markReadResponse.statusText}` })))
                            .then(markReadResult => {
                                if (markReadResult.success) { console.log(`Сообщения для задачи ${taskId} помечены как прочитанные клиентом.`); } 
                                else { console.warn(`Не удалось пометить сообщения как прочитанные клиентом для ${taskId}: ${markReadResult.message || 'Неизвестная ошибка'}`); }
                            })
                            .catch(err => console.error(`Сетевая ошибка markAsReadByClient для ${taskId}:`, err));
                        } catch (e) { console.error("Исключение JS при вызове markAsReadByClient:", e); }
                    }
                }
            } else {
                const errorText = result.message || 'Получены некорректные данные сообщений от сервера.';
                if (!isBackgroundUpdate) { throw new Error(errorText); } else { console.warn(`Фоновое обновление чата: ${errorText}`); }
            }
        } catch (error) {
            console.error('Ошибка при загрузке сообщений чата:', error.message);
            if (chatMessagesAreaElement && !isBackgroundUpdate) { 
                chatMessagesAreaElement.innerHTML = `<div class="error-message-placeholder" style="text-align:center;">Ошибка загрузки сообщений: ${error.message}</div>`;
            }
        }
    }

    async function sendChatMessage(taskId, userCode, messageText, fileToSend) {
        const chatSendButtonElement = document.getElementById('chat-send-button');
        if (!chatSendButtonElement) return false;
        const originalButtonContent = chatSendButtonElement.innerHTML;
        chatSendButtonElement.disabled = true;
        chatSendButtonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        let tempFileId = "";
        let originalFileName = "";
        try {
            if (fileToSend) {
                chatSendButtonElement.innerHTML = '<i class="fas fa-upload"></i>';
                const fileUploadResponse = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/uploadfile`, {
                    method: 'POST', body: fileToSend, headers: { 'X-File-Name': encodeURIComponent(fileToSend.name) }
                });
                if (!fileUploadResponse.ok) {
                    let errorMsg = `Ошибка загрузки файла: ${fileUploadResponse.status}`;
                    try { const errorData = await fileUploadResponse.json(); errorMsg = errorData.message || errorMsg; } catch (e) { /* не JSON */ }
                    throw new Error(errorMsg);
                }
                const fileResult = await fileUploadResponse.json();
                if (fileResult.success && fileResult.tempFileId) {
                    tempFileId = fileResult.tempFileId;
                    originalFileName = fileResult.fileName; 
                } else {
                    throw new Error(fileResult.message || 'Не удалось загрузить файл для чата.');
                }
            }
            chatSendButtonElement.innerHTML = '<i class="fas fa-paper-plane"></i>'; 
            const payload = { userCode: userCode, text: messageText };
            if (tempFileId) {
                payload.attachedFileId = tempFileId;
                payload.attachedFileName = originalFileName;
            }
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/sendmessage`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) {
                let errorMsg = `Ошибка ${response.status}`;
                try { const errorData = await response.json(); errorMsg = errorData.message ? `${errorData.message} (статус ${response.status})` : errorMsg; } catch (e) { errorMsg = `Ошибка ${response.status}: ${response.statusText}`; }
                throw new Error(`Не удалось отправить сообщение. ${errorMsg}`);
            }
            const result = await response.json();
            if (result.success && result.sentMessage) {
                displayChatMessage(result.sentMessage);
                if(document.getElementById('chat-message-input')) {
                    document.getElementById('chat-message-input').value = '';
                    document.getElementById('chat-message-input').style.height = 'auto';
                }
                currentSelectedFile = null;
                if(document.getElementById('chat-file-input')) document.getElementById('chat-file-input').value = '';
                if(document.getElementById('chat-selected-file-info')) document.getElementById('chat-selected-file-info').style.display = 'none';
                if(document.getElementById('selected-file-name')) document.getElementById('selected-file-name').textContent = '';
                const chatMessagesAreaElement = document.getElementById('chat-messages-area');
                if(chatMessagesAreaElement) chatMessagesAreaElement.scrollTop = chatMessagesAreaElement.scrollHeight;
                return true;
            } else {
                throw new Error(result.message || 'Ошибка при отправке сообщения (ответ сервера).');
            }
        } catch (error) {
            console.error('Ошибка отправки сообщения в чат:', error);
            if (error.message.toLowerCase() !== "пустое сообщение и нет файла.") {
                 alert(`Не удалось отправить сообщение: ${error.message}`);
            }
            return false;
        } finally {
            chatSendButtonElement.disabled = false;
            chatSendButtonElement.innerHTML = originalButtonContent;
        }
    }

    async function handleApproveCompletionOnDetailsPage(taskId) {
        if (!taskId) return;
        if (!confirm("Вы уверены, что хотите подтвердить выполнение этой задачи?")) return;

        const approveButton = document.querySelector(`.approve-task-btn-details[data-task-id="${taskId}"]`);
        if (approveButton) {
            approveButton.disabled = true;
            approveButton.textContent = 'Обработка...';
        }

        try {
            const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/approveCompletion`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            if (response.ok && result.success) {
                alert(result.message || 'Задача успешно отмечена как выполненная!');
                loadTaskDetailsAndChat(taskId); 
            } else {
                throw new Error(result.message || `Ошибка ${response.status}`);
            }
        } catch (error) {
            console.error('Ошибка при подтверждении выполнения задачи (детали):', error);
            alert('Не удалось подтвердить выполнение задачи: ' + error.message);
            if (approveButton) {
                approveButton.disabled = false;
                approveButton.textContent = 'Задача выполнена';
            }
        }
    }

    async function handleRequestReworkOnDetailsPage(taskId) {
        if (!taskId) return;
        const userCode = localStorage.getItem('userCode');
        if (!userCode) {
            alert("Ошибка: Код пользователя не найден. Пожалуйста, войдите снова.");
            return;
        }

        const reworkModal = document.getElementById('reworkCommentModalDetails');
        const commentTextarea = document.getElementById('reworkCommentTextareaDetails');
        const submitReworkBtn = document.getElementById('submitReworkCommentBtnDetails');
        const cancelReworkBtn = document.getElementById('cancelReworkCommentBtnDetails');
        
        if (!reworkModal || !commentTextarea || !submitReworkBtn || !cancelReworkBtn) {
            console.error("Не найдены элементы модального окна для доработки на странице деталей.");
            alert("Произошла ошибка интерфейса. Не удалось открыть окно для комментария.");
            return;
        }

        commentTextarea.value = ''; 
        reworkModal.style.display = 'flex'; 
		setupReworkFileAttachment('ReworkDetailsPage', 'reworkCommentTextareaDetails');
        commentTextarea.focus();

        const newSubmitBtn = submitReworkBtn.cloneNode(true);
        submitReworkBtn.parentNode.replaceChild(newSubmitBtn, submitReworkBtn);
        
        const newCancelBtn = cancelReworkBtn.cloneNode(true);
        cancelReworkBtn.parentNode.replaceChild(newCancelBtn, cancelReworkBtn);

        newSubmitBtn.onclick = async () => {
            const comment = commentTextarea.value.trim();
              if (comment === "") {
                // alert("Комментарий не может быть пустым для отправки на доработку."); // Старый alert
                showCustomAlert("Комментарий не может быть пустым для отправки на доработку.", () => {
                    // Этот код выполнится после закрытия кастомного алерта
                    if (commentTextarea) {
                        if (commentTextarea.disabled) {
                            commentTextarea.disabled = false;
                        }
                        commentTextarea.focus();
                        console.log('CustomAlert closed. Attempted to focus textarea. Disabled:', commentTextarea.disabled);
                        console.log('Active element:', document.activeElement);
                    }
                });
                return;
            }

            newSubmitBtn.disabled = true;
            const originalSubmitText = newSubmitBtn.textContent;
            newSubmitBtn.textContent = 'Подготовка...';

            const originalPageReworkButton = document.querySelector(`.rework-task-btn-details[data-task-id="${taskId}"]`);
            let originalReworkButtonText = '';
            if (originalPageReworkButton) {
                originalReworkButtonText = originalPageReworkButton.textContent;
                originalPageReworkButton.disabled = true;
                originalPageReworkButton.textContent = 'Обработка...';
            }
            
            let responseObj; // To store response for finally block
            let resultObj;   // To store result for finally block

            try {
                let attachedFileId = null;
                let attachedFileName = null;

                if (currentReworkFileForModal) { 
                    newSubmitBtn.textContent = 'Загрузка файла...';
                    console.log(`[ReworkSubmit task-details.html] Загрузка файла: ${currentReworkFileForModal.name}`);
                    
                    const fileUploadResponse = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/uploadfile`, {
                        method: 'POST',
                        body: currentReworkFileForModal,
                        headers: {
                            'X-File-Name': encodeURIComponent(currentReworkFileForModal.name)
                        }
                    });

                    if (!fileUploadResponse.ok) {
                        let errorMsg = `Ошибка загрузки файла (${currentReworkFileForModal.name}): ${fileUploadResponse.status}`;
                        try { 
                            const errorData = await fileUploadResponse.json(); 
                            errorMsg = errorData.message || errorMsg; 
                        } catch (e) { /* не JSON */ }
                        throw new Error(errorMsg);
                    }

                    const fileResult = await fileUploadResponse.json();
                    if (fileResult.success && fileResult.tempFileId) {
                        attachedFileId = fileResult.tempFileId;
                        attachedFileName = fileResult.fileName;
                        console.log(`[ReworkSubmit task-details.html] Файл успешно загружен: tempFileId=${attachedFileId}, fileName=${attachedFileName}`);
                    } else {
                        throw new Error(fileResult.message || `Не удалось загрузить файл "${escapeHTML(currentReworkFileForModal.name)}".`);
                    }
                }

                newSubmitBtn.textContent = 'Отправка на доработку...';

                const payload = { 
                    userCode: userCode, 
                    comment: comment 
                };
                if (attachedFileId) {
                    payload.attachedFileId = attachedFileId;
                    payload.attachedFileName = attachedFileName;
                }

                console.log(`[ReworkSubmit task-details.html] Отправка запроса на доработку для задачи ${taskId} с payload:`, JSON.stringify(payload));
                const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/chat/${taskId}/requestRework`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                responseObj = response; // Store for finally
                
                const result = await response.json().catch(() => ({ success: false, message: `Ошибка ответа сервера: ${response.status} ${response.statusText}` }));
                resultObj = result; // Store for finally

                if (response.ok && result.success) {
                    alert(result.message || 'Задача успешно отправлена на доработку!');
                    
                    commentTextarea.value = '';
                    currentReworkFileForModal = null;
                    
                    const fileInputToReset = document.getElementById('reworkFileDetailsPageInput');
                    const fileNameDisplayToReset = document.getElementById('fileNameDisplayReworkDetailsPage');
                    const imagePreviewToReset = document.getElementById('imagePreviewReworkDetailsPage');
                     if(fileInputToReset) fileInputToReset.value = '';
                    if(fileNameDisplayToReset) { fileNameDisplayToReset.innerHTML = ''; fileNameDisplayToReset.style.display = 'none';}
                    if(imagePreviewToReset) imagePreviewToReset.innerHTML = '';

                    if(reworkModal) reworkModal.style.display = 'none';

                    loadTaskDetailsAndChat(taskId); 

                } else {
                    throw new Error(result.message || `Ошибка ${response.status} при отправке на доработку.`);
                }
            } catch (error) {
                console.error('[ReworkSubmit task-details.html] Ошибка при отправке задачи на доработку:', error);
                alert('Не удалось отправить задачу на доработку: ' + error.message);
                if (originalPageReworkButton && originalPageReworkButton.parentNode) {
                    originalPageReworkButton.disabled = false;
                    originalPageReworkButton.textContent = originalReworkButtonText || 'Отправить на доработку'; 
                }
            } finally {
                newSubmitBtn.disabled = false;
                newSubmitBtn.textContent = originalSubmitText;
                
                if (reworkModal && reworkModal.style.display === 'flex' && !(responseObj && responseObj.ok && resultObj && resultObj.success)) {
                    // Окно остается открытым при ошибке
                } else if (reworkModal) {
                    reworkModal.style.display = 'none';
                }
            }
        };
        
        newCancelBtn.onclick = () => {
            if (reworkModal) reworkModal.style.display = 'none';
            currentReworkFileForModal = null; // Сбрасываем выбранный файл
             // Сброс UI файла в модальном окне task-details.html
            const fileInputToReset = document.getElementById('reworkFileDetailsPageInput');
            const fileNameDisplayToReset = document.getElementById('fileNameDisplayReworkDetailsPage');
            const imagePreviewToReset = document.getElementById('imagePreviewReworkDetailsPage');
            if(fileInputToReset) fileInputToReset.value = '';
            if(fileNameDisplayToReset) { fileNameDisplayToReset.innerHTML = ''; fileNameDisplayToReset.style.display = 'none';}
            if(imagePreviewToReset) imagePreviewToReset.innerHTML = '';
        };
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
        currentOpenTaskId = localStorage.getItem('currentTaskId');
        const taskNumberFromStorage = localStorage.getItem('currentTaskNumber');
        const userCode = localStorage.getItem('userCode');
        const taskTitleElement = document.getElementById('task-title');
        const chatMessageInputElement = document.getElementById('chat-message-input');
        const chatSendButtonElement = document.getElementById('chat-send-button');
        const chatAttachFileButton = document.getElementById('chat-attach-file-button');
        const chatFileInput = document.getElementById('chat-file-input');
        const chatSelectedFileInfoDiv = document.getElementById('chat-selected-file-info');
        const selectedFileNameSpan = document.getElementById('selected-file-name');
        const chatRemoveSelectedFileButton = document.getElementById('chat-remove-selected-file');

        if (!userCode) { 
            alert("Ошибка: Код пользователя не найден. Пожалуйста, войдите снова.");
            window.location.href = 'index.html';
            return;
        }
        if (taskNumberFromStorage) {
            if(taskTitleElement) taskTitleElement.textContent = `Задача №${escapeHTML(taskNumberFromStorage)}`;
        } else if (currentOpenTaskId) {
            if(taskTitleElement) taskTitleElement.textContent = `Задача (ID: ${escapeHTML(currentOpenTaskId.substring(0,8))}...)`;
        } else {
            if(taskTitleElement) taskTitleElement.textContent = 'Детали задачи';
            const taskDetailsContentElement = document.getElementById('task-details-content');
            const attachedFilesListElement = document.getElementById('attached-files');
            if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="error-message-placeholder">Ошибка: ID задачи не найден.</div>';
            if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Файлы не загружены.</li>';
            if(chatMessageInputElement) chatMessageInputElement.disabled = true;
            if(chatSendButtonElement) chatSendButtonElement.disabled = true;
            if(chatAttachFileButton) chatAttachFileButton.disabled = true;
            return;
        }
        if (!currentOpenTaskId) return; 
        loadTaskDetailsAndChat(currentOpenTaskId); 

        if (chatMessageInputElement) {
            chatMessageInputElement.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
            chatMessageInputElement.addEventListener('keypress', function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); if (chatSendButtonElement) { chatSendButtonElement.click();}}});
        }
        if (chatAttachFileButton && chatFileInput) {
            chatAttachFileButton.addEventListener('click', () => chatFileInput.click());
            chatFileInput.addEventListener('change', function(event) {
                currentSelectedFile = event.target.files[0];
                if (currentSelectedFile) { if(selectedFileNameSpan) selectedFileNameSpan.textContent = escapeHTML(currentSelectedFile.name); if(chatSelectedFileInfoDiv) chatSelectedFileInfoDiv.style.display = 'block'; } 
                else { if(chatSelectedFileInfoDiv) chatSelectedFileInfoDiv.style.display = 'none'; }
            });
        }
        if (chatRemoveSelectedFileButton) {
            chatRemoveSelectedFileButton.addEventListener('click', () => {
                currentSelectedFile = null; if(chatFileInput) chatFileInput.value = ''; 
                if(chatSelectedFileInfoDiv) chatSelectedFileInfoDiv.style.display = 'none'; if(selectedFileNameSpan) selectedFileNameSpan.textContent = '';
            });
        }
        if (chatSendButtonElement && chatMessageInputElement) {
            chatSendButtonElement.addEventListener('click', async () => {
                const messageText = chatMessageInputElement.value.trim();
                if (!messageText && !currentSelectedFile) { chatMessageInputElement.focus(); return; }
                if (currentOpenTaskId && userCode) { 
                    const success = await sendChatMessage(currentOpenTaskId, userCode, messageText, currentSelectedFile);
                    if (success) { chatMessageInputElement.value = ''; chatMessageInputElement.style.height = 'auto'; }
                } else { alert("Ошибка: не удалось определить ID задачи или код пользователя для отправки сообщения."); }
            });
        }
    });

    window.addEventListener('beforeunload', () => {
        if (chatUpdateIntervalId) { clearInterval(chatUpdateIntervalId); }
    });

async function loadAndDisplayStatusHistory(taskId) {
    console.log("loadAndDisplayStatusHistory вызвана с taskId:", taskId);
    const historyContainer = document.getElementById('taskStatusHistoryContainer');
    if (!historyContainer) {
        console.error("Элемент #taskStatusHistoryContainer не найден.");
        return;
    }
    historyContainer.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Загрузка истории статусов...</p>';

    const currentClientUserName = localStorage.getItem('userName');

    try {
        const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/task/${taskId}/statusHistory`);
        console.log("Ответ от statusHistory fetch, status:", response.status);
        if (!response.ok) {
            let errorMsg = `Ошибка загрузки истории статусов: ${response.status}`;
            try {
                const errorData = await response.json();
                if (errorData && errorData.message) { errorMsg = errorData.message; }
                console.error("Ошибка ответа сервера (statusHistory - не ок):", errorData || errorMsg);
            } catch (e) { 
                console.error("Ошибка ответа сервера (statusHistory - не ок, не JSON):", errorMsg);
            }
            throw new Error(errorMsg);
        }
        const result = await response.json();
        console.log("Результат JSON от statusHistory:", result);

        if (result.success && result.history) { 
            if (result.history.length > 0) {
                let historyHTML = '<ul class="status-history-list">';
                result.history.forEach((entry, index) => {
                    let displayAuthorName = '';
                    if (entry.authorName && currentClientUserName && entry.authorName.trim().toLowerCase() === currentClientUserName.trim().toLowerCase()) {
                        displayAuthorName = escapeHTML(currentClientUserName);
                    } else {
                        displayAuthorName = 'ЦР';
                    }
                    
                    const itemClass = (result.history.length > 1 && index > 0) ? "status-history-item hidden-history-entry" : "status-history-item";

                    historyHTML += `
                        <li class="${itemClass}">
                            <span class="history-date">${escapeHTML(entry.changeDate)}</span>
                            <span class="history-status">Статус изменен на: <strong>${escapeHTML(entry.newStatus)}</strong></span>
                            <span class="history-author">(Автор: ${displayAuthorName})</span> 
                            ${entry.oldStatus && entry.oldStatus !== "ПустаяСсылка" && entry.oldStatus !== "" ? `<span class="history-old-status">(Старый статус: ${escapeHTML(entry.oldStatus)})</span>` : ''}
                        </li>`;
                });
                historyHTML += '</ul>';

                if (result.history.length > 1) {
                    historyHTML += '<button id="toggleHistoryBtn" class="toggle-history-button">Вся история</button>';
                }
                historyContainer.innerHTML = historyHTML;

                if (result.history.length > 1) {
                    const toggleBtn = document.getElementById('toggleHistoryBtn');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', function() {
                            const list = historyContainer.querySelector('.status-history-list');
                            let allHiddenInitially = true;
                            list.querySelectorAll('.status-history-item').forEach((item, index) => {
                                if (index > 0) { // Проверяем только элементы, которые могут быть скрыты
                                    if (!item.classList.contains('hidden-history-entry')) {
                                        allHiddenInitially = false; // Если хоть один видимый (кроме первого), значит не все были скрыты
                                    }
                                }
                            });

                            list.querySelectorAll('.status-history-item').forEach((item, index) => {
                                if (index > 0) { 
                                    if (allHiddenInitially) { // Если все были скрыты, раскрываем
                                        item.classList.remove('hidden-history-entry');
                                    } else { // Иначе (если хоть что-то было раскрыто), скрываем
                                        item.classList.add('hidden-history-entry');
                                    }
                                }
                            });
                            
                            if (allHiddenInitially) {
                                this.textContent = 'Скрыть историю';
                            } else {
                                this.textContent = 'Вся история';
                            }
                        });
                    }
                }

            } else { 
                historyContainer.innerHTML = '<p>История изменения статусов для этой задачи пока отсутствует.</p>';
            }
        } else {
            console.error("Ошибка в данных ответа statusHistory:", result.message || 'Не удалось получить данные истории статусов.');
            throw new Error(result.message || 'Не удалось получить данные истории статусов.');
        }
    } catch (error) {
        console.error('Ошибка при загрузке истории статусов (внешний catch):', error);
        historyContainer.innerHTML = `<p class="error-message-placeholder">Не удалось загрузить историю статусов: ${error.message}</p>`;
    }
}

async function loadTaskDetailsAndChat(taskId) {
    currentOpenTaskId = taskId; 
    const taskDetailsContentElement = document.getElementById('task-details-content');
    const attachedFilesListElement = document.getElementById('attached-files'); 
    const actionsPlaceholder = document.getElementById('taskDetailActionsPlaceholder');

    if(actionsPlaceholder) actionsPlaceholder.innerHTML = '';
    if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = '<div class="loading-spinner" style="text-align:left; padding-left:0;">Загрузка деталей...</div>';
    if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li><i class="fas fa-spinner fa-spin"></i> Загрузка файлов...</li>';
    
    const historyContainer = document.getElementById('taskStatusHistoryContainer');
    if (historyContainer) {
        historyContainer.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Загрузка истории статусов...</p>';
    }
    
    try {
        const response = await fetch(`https://1c.c-r.kz/Registrator_test/hs/auth/task/${taskId}`);
        if (!response.ok) {
            let errorMsg = `Ошибка ${response.status}`;
            try { const errorData = await response.json(); errorMsg = errorData.message ? `${errorData.message} (${response.status})` : errorMsg; } catch (e) { errorMsg = `Ошибка ${response.status}: ${response.statusText}`; }
            throw new Error(`Не удалось загрузить данные задачи. ${errorMsg}`);
        }
        const result = await response.json();
        if (result.success && result.task) {
            displayTaskDetails(result.task); 
            await loadChatMessages(taskId);   
            await loadAndDisplayStatusHistory(taskId);
            
            if (chatUpdateIntervalId) clearInterval(chatUpdateIntervalId);
            chatUpdateIntervalId = setInterval(() => {
                loadChatMessages(taskId, true); 
            }, CHAT_UPDATE_INTERVAL);
        } else {
            throw new Error(result.message || 'Получены некорректные данные о задаче.');
        }
    } catch (error) {
        console.error('Ошибка при загрузке деталей задачи:', error);
        if(taskDetailsContentElement) taskDetailsContentElement.innerHTML = `<div class="error-message-placeholder">Ошибка: ${error.message}</div>`;
        if(attachedFilesListElement) attachedFilesListElement.innerHTML = '<li>Ошибка загрузки файлов.</li>';
        if (historyContainer) { 
             historyContainer.innerHTML = `<p class="error-message-placeholder">Ошибка загрузки истории статусов.</p>`;
        }
    }
}

function setupReworkFileAttachment(modalElementsPrefix, commentTextareaId) {
    const dropZone = document.getElementById(`dropZone${modalElementsPrefix}`);
    const fileInput = document.getElementById(`${modalElementsPrefix}Input`);
    const fileNameDisplay = document.getElementById(`fileNameDisplay${modalElementsPrefix}`);
    const imagePreviewContainer = document.getElementById(`imagePreview${modalElementsPrefix}`);
    const commentTextarea = document.getElementById(commentTextareaId);
    const dropZonePrompt = dropZone ? dropZone.querySelector('.drop-zone-prompt') : null;


    if (!dropZone || !fileInput || !fileNameDisplay || !imagePreviewContainer || !commentTextarea || !dropZonePrompt ) {
        console.error(`[setupReworkFileAttachment] Ошибка: Не найдены все необходимые DOM-элементы для префикса: ${modalElementsPrefix}`);
        return;
    }

    const resetFileInputUI = () => {
        currentReworkFileForModal = null;
        if(fileInput) fileInput.value = ''; 
        if(fileNameDisplay) {
            fileNameDisplay.innerHTML = '';
            fileNameDisplay.style.display = 'none';
        }
        if(imagePreviewContainer) imagePreviewContainer.innerHTML = '';
        if(dropZonePrompt) {
            dropZonePrompt.style.display = 'block'; // Показываем подсказку обратно
        }
        console.log(`[${modalElementsPrefix}] UI выбора файла сброшен.`);
    };

    resetFileInputUI();

    const processSelectedFile = (file) => {
        if (!file) {
            resetFileInputUI();
            return;
        }
        
        const MAX_FILE_SIZE_MB = 30;
        const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;
        if (file.size > MAX_FILE_SIZE_BYTES) {
            alert(`Файл слишком большой. Максимальный размер: ${MAX_FILE_SIZE_MB} МБ.`);
            resetFileInputUI();
            return;
        }

        currentReworkFileForModal = file;
        
        if(fileNameDisplay) {
            fileNameDisplay.innerHTML = `Выбран: <span>${escapeHTML(file.name)}</span> <a href="#" class="remove-rework-file" title="Удалить файл">&times;</a>`;
            fileNameDisplay.style.display = 'block';
            if(dropZonePrompt) {
                dropZonePrompt.style.display = 'none'; // Скрываем подсказку, так как файл выбран
            }

            const removeLink = fileNameDisplay.querySelector('.remove-rework-file');
            if (removeLink) {
                removeLink.onclick = (e) => {
                    e.preventDefault();
                    resetFileInputUI();
                };
            }
        }

        if(imagePreviewContainer) imagePreviewContainer.innerHTML = ''; 
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '80px'; 
                img.style.maxHeight = '80px';
                img.style.borderRadius = '4px';
                img.style.objectFit = 'cover';
                if(imagePreviewContainer) imagePreviewContainer.appendChild(img);
            };
            reader.onerror = () => {
                console.error(`[${modalElementsPrefix}] Ошибка чтения файла для превью: ${file.name}`);
                if(imagePreviewContainer) imagePreviewContainer.innerHTML = '<p style="font-size:0.8em; color:red;">Не удалось показать превью.</p>';
            }
            reader.readAsDataURL(file);
        }
        console.log(`[${modalElementsPrefix}] Файл выбран: ${file.name}`);
    };

    dropZone.onclick = (e) => {
        if (e.target.classList.contains('remove-rework-file')) {
            return;
        }
        fileInput.click();
    };

    fileInput.onchange = (e) => {
        if (e.target.files && e.target.files.length > 0) {
            processSelectedFile(e.target.files[0]);
        } else {
             if (!currentReworkFileForModal && fileInput.files.length === 0) { 
                resetFileInputUI();
             }
        }
    };

    dropZone.ondragover = (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    };
    dropZone.ondragleave = (e) => {
        dropZone.classList.remove('drag-over');
    };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            processSelectedFile(e.dataTransfer.files[0]); 
        }
    };

    commentTextarea.onpaste = (event) => {
        if (currentReworkFileForModal) { 
            console.log(`[${modalElementsPrefix}] Вставка из буфера проигнорирована, т.к. файл уже выбран.`);
            return;
        }
        const items = (event.clipboardData || window.clipboardData)?.items;
        if (!items) return;
        let pastedImageFile = null;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                pastedImageFile = items[i].getAsFile();
                break;
            }
        }
        if (pastedImageFile) {
            event.preventDefault(); 
            const timestamp = new Date().toISOString().replace(/[-:.]/g, '').substring(0,14);
            const extension = pastedImageFile.type.split('/')[1] || 'png';
            const fileName = `clipboard-${timestamp}.${extension}`;
            const fileToAdd = new File([pastedImageFile], fileName, {type: pastedImageFile.type});
            processSelectedFile(fileToAdd);
            console.log(`[${modalElementsPrefix}] Изображение вставлено из буфера обмена: ${fileName}`);
        }
    };
    console.log(`[setupReworkFileAttachment] Настройка UI для прикрепления файла для префикса ${modalElementsPrefix} завершена.`);
}



function showCustomAlert(message, callback) {
    const overlay = document.getElementById('customAlertOverlay');
    const messageElement = document.getElementById('customAlertMessage');
    const okButton = document.getElementById('customAlertOkButton');

    if (!overlay || !messageElement || !okButton) {
        console.error('Custom alert elements not found!');
        // Fallback to system alert if custom elements are missing
        alert(message);
        if (callback) callback();
        return;
    }

    messageElement.textContent = message;
    overlay.style.display = 'flex';

    // Удаляем старый обработчик, если он был, чтобы избежать многократных вызовов
    const newOkButton = okButton.cloneNode(true);
    okButton.parentNode.replaceChild(newOkButton, okButton);

    newOkButton.onclick = function() {
        overlay.style.display = 'none';
        if (callback) {
            callback(); // Выполняем callback после закрытия
        }
    };
    newOkButton.focus(); // Устанавливаем фокус на кнопку "ОК" в кастомном алерте
}

</script>
</body>
</html>


